<app-layout>
  <div class="inversiones-container">
    @if (cargando) {
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    }
    
    <div class="panel-header">
      <div>
        <p class="eyebrow">Panel en vivo · Bitget</p>
        <h1>Inversiones</h1>
        <p class="subtitle">Tokens del panel actualizados en tiempo real vía WebSocket</p>
      </div>
      <div class="status-group">
        <mat-chip-set>
          <mat-chip [color]="connectionStatus === 'connected' ? 'primary' : 'warn'" selected>
            <mat-icon>{{ connectionStatus === 'connected' ? 'cloud_done' : (connectionStatus === 'connecting' ? 'sync' : 'cloud_off') }}</mat-icon>
            <span class="chip-text">
              {{ connectionStatus === 'connected' ? 'Bitget · Conectado' : connectionStatus === 'connecting' ? 'Bitget · Conectando' : 'Bitget · Desconectado' }}
            </span>
          </mat-chip>
          <mat-chip [color]="binanceStatus === 'connected' ? 'primary' : 'warn'" selected>
            <mat-icon>{{ binanceStatus === 'connected' ? 'cloud_done' : (binanceStatus === 'connecting' ? 'sync' : 'cloud_off') }}</mat-icon>
            <span class="chip-text">
              {{ binanceStatus === 'connected' ? 'Binance · Conectado' : binanceStatus === 'connecting' ? 'Binance · Conectando' : 'Binance · Desconectado' }}
            </span>
          </mat-chip>
        </mat-chip-set>
        <button mat-raised-button color="primary" (click)="nuevaTenencia()" style="margin-left: 16px;">
          <mat-icon>add</mat-icon>
          Nueva Tenencia
        </button>
      </div>
    </div>

    <!-- Formulario de Tenencia -->
    @if (mostrandoFormTenencia()) {
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>{{ editandoTenencia() ? 'Editar Tenencia' : 'Nueva Tenencia' }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <form [formGroup]="tenenciaForm" (ngSubmit)="guardarTenencia()">
            <div class="form-grid">
              <mat-form-field appearance="outline">
                <mat-label>Símbolo (InstId)</mat-label>
                <mat-select formControlName="instId" required>
                  @for (simbolo of simbolos; track simbolo.instId) {
                    <mat-option [value]="simbolo.instId">
                      {{ simbolo.display }} ({{ simbolo.instId }})
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Símbolo Display</mat-label>
                <input matInput formControlName="symbol" required>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Cantidad</mat-label>
                <input matInput type="number" formControlName="amount" required>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Porcentaje (%)</mat-label>
                <input matInput type="number" formControlName="percentage">
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Fuente</mat-label>
                <mat-select formControlName="source" required>
                  <mat-option value="bitget">Bitget</mat-option>
                  <mat-option value="binance">Binance</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Nombre Display</mat-label>
                <input matInput formControlName="display">
              </mat-form-field>
            </div>

            <div class="form-actions">
              <button mat-button type="button" (click)="cancelarFormTenencia()">
                Cancelar
              </button>
              <button mat-raised-button color="primary" type="submit">
                {{ editandoTenencia() ? 'Actualizar' : 'Guardar' }}
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    }

    <!-- Balance Total -->
    <div class="balance-section">
      <mat-card class="balance-card">
        <mat-card-content>
          <div class="balance-content">
            <div class="balance-label">
              <mat-icon>account_balance_wallet</mat-icon>
              <span>Balance Total</span>
            </div>
            <div class="balance-value">
              ${{ formatNumber(totalBalance, 2) }}
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Holdings List -->
      <mat-card class="holdings-card">
        <mat-card-content>
          <h3 class="holdings-title">Tenencias</h3>
          <div class="holdings-list">
            @for (holding of holdings(); track holding.id) {
              <div class="holding-item">
                <div class="holding-info">
                  <div class="holding-symbol">{{ holding.symbol }}</div>
                  <div class="holding-amount">{{ formatNumber(holding.amount, 4) }}</div>
                </div>
                <div class="holding-value">
                  ${{ formatNumber(getHoldingValue(holding.instId), 2) }}
                </div>
                <div class="holding-actions">
                  <button mat-icon-button (click)="editarTenencia(holding)" matTooltip="Editar">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button (click)="eliminarTenencia(holding)" color="warn" matTooltip="Eliminar">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            }
            @if (holdings().length === 0) {
              <div class="empty-state">
                <mat-icon>info</mat-icon>
                <p>No tienes tenencias registradas</p>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="tokens-wrapper">
      <div class="tokens-section negative-section">
        <h3 class="section-title">En Baja</h3>
        <div class="cards-grid" #negativeCarousel>
          <mat-card class="token-card" *ngFor="let row of negativeTokens">
            <div class="token-header">
              <div class="token-icon">{{ row.display.split('/')[0].trim().substring(0, 3) }}</div>
              <div class="token-info">
                <div class="token-name">{{ row.display }}</div>
                <div class="token-id">{{ row.instId }} · {{ row.source === 'binance' ? 'Binance' : 'Bitget' }}</div>
              </div>
            </div>
            <div class="token-body">
              <div class="price">{{ formatNumber(row.last, 4) }}</div>
              <div class="change down">
                <mat-icon>trending_down</mat-icon>
                <span>{{ row.changePct !== undefined ? (row.changePct | number:'1.2-2') + '%' : '-' }}</span>
              </div>
            </div>
          </mat-card>
        </div>
      </div>

      <div class="tokens-section positive-section">
        <h3 class="section-title">En Alza</h3>
        <div class="cards-grid" #positiveCarousel>
          <mat-card class="token-card" *ngFor="let row of positiveTokens">
            <div class="token-header">
              <div class="token-icon">{{ row.display.split('/')[0].trim().substring(0, 3) }}</div>
              <div class="token-info">
                <div class="token-name">{{ row.display }}</div>
                <div class="token-id">{{ row.instId }} · {{ row.source === 'binance' ? 'Binance' : 'Bitget' }}</div>
              </div>
            </div>
            <div class="token-body">
              <div class="price">{{ formatNumber(row.last, 4) }}</div>
              <div class="change up">
                <mat-icon>trending_up</mat-icon>
                <span>{{ row.changePct !== undefined ? (row.changePct | number:'1.2-2') + '%' : '-' }}</span>
              </div>
            </div>
          </mat-card>
        </div>
      </div>
    </div>
  </div>
</app-layout>
